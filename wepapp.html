<!DOCTYPE html>

<html lang="ar" dir="rtl">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ø§Ù„ØªØµÙˆÙŠØª</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }

        

        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            min-height: 100vh;

            display: flex;

            align-items: center;

            justify-content: center;

            padding: 20px;

        }

        

        .container {

            background: white;

            border-radius: 20px;

            padding: 30px;

            box-shadow: 0 10px 40px rgba(0,0,0,0.2);

            max-width: 400px;

            width: 100%;

            text-align: center;

        }

        

        h1 {

            color: #667eea;

            margin-bottom: 10px;

            font-size: 24px;

        }

        

        .info {

            color: #666;

            margin-bottom: 20px;

            font-size: 14px;

        }

        

        .status {

            padding: 15px;

            border-radius: 10px;

            margin: 20px 0;

            font-weight: bold;

        }

        

        .status.loading {

            background: #fff3cd;

            color: #856404;

        }

        

        .status.success {

            background: #d4edda;

            color: #155724;

        }

        

        .status.error {

            background: #f8d7da;

            color: #721c24;

        }

        

        .vote-btn {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;

            border: none;

            padding: 15px 40px;

            border-radius: 50px;

            font-size: 16px;

            font-weight: bold;

            cursor: pointer;

            transition: transform 0.2s;

            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);

            display: none;

        }

        

        .vote-btn:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.6);

        }

        

        .vote-btn:disabled {

            opacity: 0.6;

            cursor: not-allowed;

        }

        

        .spinner {

            border: 3px solid #f3f3f3;

            border-top: 3px solid #667eea;

            border-radius: 50%;

            width: 40px;

            height: 40px;

            animation: spin 1s linear infinite;

            margin: 20px auto;

        }

        

        @keyframes spin {

            0% { transform: rotate(0deg); }

            100% { transform: rotate(360deg); }

        }

        

        .ip-info {

            background: #f8f9fa;

            padding: 10px;

            border-radius: 8px;

            margin: 15px 0;

            font-size: 12px;

            color: #666;

            display: none;

        }

    </style>

</head>

<body>

    <div class="container">

        <h1>ğŸ—³ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª</h1>

        <p class="info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...</p>

        

        <div id="status" class="status loading">

            <div class="spinner"></div>

            <div>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>

        </div>

        

        <div id="ipInfo" class="ip-info">

            IP Address: <span id="ipAddress">-</span>

        </div>

        

        <button id="voteBtn" class="vote-btn">

            ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª

        </button>

    </div>

    <script>

        let tg = window.Telegram.WebApp;

        tg.expand();

        

        let userIP = null;

        let contestId = null;

        let participantUsername = null;

        

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† URL

        const urlParams = new URLSearchParams(window.location.search);

        contestId = urlParams.get('contest_id');

        participantUsername = urlParams.get('username');

        

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ù…Ù† Ø®Ø¯Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ©

        async function getUserIP() {

            try {

                const response = await fetch('https://api.ipify.org?format=json');

                const data = await response.json();

                return data.ip;

            } catch (error) {

                console.error('Error getting IP:', error);

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©

                try {

                    const response = await fetch('https://api.ip.sb/ip');

                    const ip = await response.text();

                    return ip.trim();

                } catch (error2) {

                    console.error('Error with backup IP service:', error2);

                    return null;

                }

            }

        }

        

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

        async function initializeVote() {

            const statusDiv = document.getElementById('status');

            const voteBtn = document.getElementById('voteBtn');

            const ipInfo = document.getElementById('ipInfo');

            const ipAddress = document.getElementById('ipAddress');

            

            try {

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP

                userIP = await getUserIP();

                

                if (userIP) {

                    ipAddress.textContent = userIP;

                    ipInfo.style.display = 'block';

                    

                    statusDiv.className = 'status success';

                    statusDiv.innerHTML = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!<br>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØµÙˆÙŠØª';

                    

                    voteBtn.style.display = 'inline-block';

                    voteBtn.disabled = false;

                } else {

                    throw new Error('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† IP');

                }

            } catch (error) {

                statusDiv.className = 'status error';

                statusDiv.innerHTML = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚<br>' + error.message;

            }

        }

        

        // Ø²Ø± Ø§Ù„ØªØµÙˆÙŠØª

        document.getElementById('voteBtn').addEventListener('click', function() {

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª

            const data = {

                ip: userIP,

                contest_id: contestId,

                username: participantUsername,

                user_id: tg.initDataUnsafe?.user?.id

            };

            

            tg.sendData(JSON.stringify(data));

            tg.close();

        });

        

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„

        initializeVote();

        

        // ØªØ¬Ù‡ÙŠØ² Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚

        tg.MainButton.setText('Ø¥ØºÙ„Ø§Ù‚');

        tg.MainButton.onClick(function() {

            tg.close();

        });

        tg.MainButton.show();

    </script>

</body>

</html>